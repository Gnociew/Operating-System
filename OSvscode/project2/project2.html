<!DOCTYPE html><html><head>
      <title>project2</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\86182\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.13\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="华东师范大学数据学院实验报告">华东师范大学数据学院实验报告 </h1>
<table>
  <tbody><tr>
    <td>课程名称 ：操作系统</td>
    <td>年级：2022级</td>
    <td>上机实践成绩：</td>
  </tr>
  <tr>
    <td>指导教师：翁楚良</td>
    <td>姓名：刘蔚璁</td>
    <td></td>
  </tr>
  <tr>
    <td>上机实践名称：彩票调度 </td>
    <td>学号：10225501443</td>
    <td>上机实践日期：2024.4</td>
  </tr>
</tbody></table>
<h2 id="一-实验目的">一、实验目的 </h2>
<ul>
<li>熟悉调度程序的工作原理。</li>
</ul>
<h2 id="二-实验内容">二、实验内容 </h2>
<ul>
<li>将调度程序更改为新的彩票调度算法。</li>
</ul>
<h2 id="三-实验环境">三、实验环境 </h2>
<p>VSCode</p>
<h2 id="四-实验过程及结果">四、实验过程及结果 </h2>
<h3 id="预备知识">预备知识 </h3>
<p>在开始实验前，首先需要了解彩票调度的思想与 xv6 的运行原理。</p>
<ul>
<li>
<h4>彩票调度</h4>
<ul>
<li>核心思想<br>
通过分配不同数量的彩票给不同的进程，来决定进程被选中执行的概率。通常情况下，彩票数越多的进程被选中的概率就越高。</li>
<li>步骤
<ul>
<li>分配彩票：为每个可运行的进程分配一定数量的彩票。</li>
<li>抽奖：当需要选择下一个要运行的进程时，系统会模拟彩票抽奖的过程。即，系统会根据每个进程拥有的彩票数量计算出总共的彩票数，并随机生成一个小于等于总彩票数的随机数作为中奖号码。</li>
<li>选择进程：根据抽奖得到的中奖号码，系统将选择拥有彩票的进程中彩票数累加后刚好大于等于中奖号码的那个进程作为下一个要执行的进程。</li>
<li>执行进程：选中的进程将被调度到 CPU 上执行，直到完成其任务或者被其他进程抢占CPU。</li>
</ul>
</li>
</ul>
</li>
<li>
<h4>XV6</h4>
<p>要完成这个实验，最基本的就是要了解 xv6 进程调度和系统调用的运行原理，我参考了 xv6 的中文文档来了解这个操作系统（<a href="https://th0ar.gitbooks.io/xv6-chinese/content/index.html%EF%BC%89">https://th0ar.gitbooks.io/xv6-chinese/content/index.html）</a></p>
<ul>
<li>
<h5>操作系统接口</h5>
<p>xv6 分为用户空间和内核空间，进程通过系统调用来使用内核服务，系统调用会进入内核，让内核执行服务然后返回。<br>
<img src="%E6%9E%B6%E6%9E%84.jpg" alt="1"><br>
内核提供的一系列系统调用就是用户程序可见的操作系统接口，比如 <code>fork()</code>、<code>exit()</code>、<code>wait()</code> 等等。</p>
</li>
<li>
<h5>进程</h5>
<p>进程是一个抽象概念，它让一个程序可以假设它独占一台机器，xv6 使用页表（由硬件实现）来为每个进程提供其独有的地址空间。<br>
一个 xv6 进程分为：</p>
<ul>
<li>用户内存空间（指令、数据、栈）</li>
<li>仅对内核可见的进程状态</li>
</ul>
<p>在xv6中，对进程控制块 <code>struct proc</code> 的定义和相关的操作函数实现，例如进程的初始化、创建和销毁等主要在 <code>proc.c</code> 中实现。<br>
每个进程都有一张表 <code>struct proc</code>，它是操作系统内核用来跟踪和管理系统中所有进程的数据结构，在 <code>proc.h</code> 中定义：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-enum">enum</span> <span class="token class-name">procstate</span> <span class="token punctuation">{</span> UNUSED<span class="token punctuation">,</span> EMBRYO<span class="token punctuation">,</span> SLEEPING<span class="token punctuation">,</span> RUNNABLE<span class="token punctuation">,</span> RUNNING<span class="token punctuation">,</span> ZOMBIE <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword keyword-struct">struct</span> <span class="token class-name">proc</span> <span class="token punctuation">{</span>
uint sz<span class="token punctuation">;</span>                     <span class="token comment">// 表示进程的内存大小，以字节为单位</span>
<span class="token class-name">pde_t</span><span class="token operator">*</span> pgdir<span class="token punctuation">;</span>                <span class="token comment">// 指向页表的指针，用于管理进程的虚拟内存</span>
<span class="token keyword keyword-char">char</span> <span class="token operator">*</span>kstack<span class="token punctuation">;</span>                <span class="token comment">// 指向内核栈底部的指针，用于保存进程在内核态执行时的栈信息</span>
<span class="token keyword keyword-enum">enum</span> <span class="token class-name">procstate</span> state<span class="token punctuation">;</span>        <span class="token comment">// 表示进程的状态，是一个枚举类型</span>
<span class="token keyword keyword-int">int</span> pid<span class="token punctuation">;</span>                     <span class="token comment">// 进程的唯一标识符，即进程ID</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>         <span class="token comment">// 指向父进程的指针</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">trapframe</span> <span class="token operator">*</span>tf<span class="token punctuation">;</span>        <span class="token comment">// 指向当前系统调用的陷阱帧的指针，用于保存进程在用户态被中断时的寄存器状态</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">context</span> <span class="token operator">*</span>context<span class="token punctuation">;</span>     <span class="token comment">// 指向上下文切换信息的指针，用于保存进程在内核态被中断时的上下文信息</span>
<span class="token keyword keyword-void">void</span> <span class="token operator">*</span>chan<span class="token punctuation">;</span>                  <span class="token comment">// 如果进程正在等待某个条件（如等待文件I/O完成），则指向该条件的指针</span>
<span class="token keyword keyword-int">int</span> killed<span class="token punctuation">;</span>                  <span class="token comment">// 如果非零，表示进程已经被杀死</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>ofile<span class="token punctuation">[</span>NOFILE<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 表示进程打开的文件数组</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>cwd<span class="token punctuation">;</span>           <span class="token comment">// 指向当前工作目录的指针</span>
<span class="token keyword keyword-char">char</span> name<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>               <span class="token comment">// 进程名称，用于调试目的</span>
<span class="token keyword keyword-int">int</span> ticket<span class="token punctuation">;</span>                  <span class="token comment">//进程彩票数</span>
<span class="token keyword keyword-int">int</span> tick<span class="token punctuation">;</span>                    <span class="token comment">//时间片数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>每个进程都有用户栈和内核栈 <code>p-&gt;kstack</code> 。当进程运行用户指令时，只有用户栈被使用，内核栈则是空的。当进程通过系统调用或中断进入内核时，内核代码就在进程的内核栈中执行；进程处于内核中时，其用户栈仍然保存着数据，只是暂时处于不活跃状态。</p>
<ul>
<li>
<h5>创建进程</h5>
在 main 初始化了一些设备和子系统后，它通过调用 <code>userinit</code> 建立了第一个进程,它首先调用 <code>allocproc</code> 分配结构体 <code>struct proc</code> 并对其进行初始化。 <code>allocproc</code> 在每个进程被创建时都会被调用。<br>
（ <code>userinit</code> 和 <code>allocproc</code> 都在 <code>proc.c</code> 中 ）</li>
<li>
<h5>运行进程</h5>
在 <code>main</code> 调用了 <code>userinit</code> 之后， <code>mpmain</code> 调用 <code>scheduler</code> 开始运行进程:
<ul>
<li><code>scheduler</code> 会找到为一个 <code>p-&gt;state</code> 为 <code>RUNNABLE</code> 的进程 <code>initproc</code> ，然后将 <code>per-cpu</code> 的变量 <code>proc</code> 为该进程，接着调用 <code>switchuvm</code> 通知硬件开始使用目标进程的页表。</li>
<li><code>scheduler</code> 接着把进程的 <code>p-&gt;state</code> 设置为 <code>RUNNING</code>，调用 <code>swtch</code>，切换上下文到目标进程的内核线程中。</li>
</ul>
</li>
<li>
<h5>CPU</h5>
<code>proc.h</code> 中定义了 CPU 结构体，包含 CPU 的一些信息和状态<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">cpu</span> <span class="token punctuation">{</span>
uchar apicid<span class="token punctuation">;</span>                <span class="token comment">// 本地 APIC 的 ID，用于多处理器系统中识别每个处理器</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">context</span> <span class="token operator">*</span>scheduler<span class="token punctuation">;</span>   <span class="token comment">// 指向 context 结构体的指针，用于在进程调度时执行上下文切换</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">taskstate</span> ts<span class="token punctuation">;</span>         <span class="token comment">// 由 x86 架构使用的任务状态段，用于在中断时找到中断处理程序所需的堆栈</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">segdesc</span> gdt<span class="token punctuation">[</span>NSEGS<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// x86 全局描述符表（Global Descriptor Table），用于管理内存段的访问权限和属性</span>
<span class="token keyword keyword-volatile">volatile</span> uint started<span class="token punctuation">;</span>       <span class="token comment">//  CPU 是否已经启动的标志</span>
<span class="token keyword keyword-int">int</span> ncli<span class="token punctuation">;</span>                    <span class="token comment">//  pushcli 函数的调用深度，用于跟踪中断嵌套</span>
<span class="token keyword keyword-int">int</span> intena<span class="token punctuation">;</span>                  <span class="token comment">// 在调用 pushcli 之前中断是否被启用的标志</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>proc<span class="token punctuation">;</span>           <span class="token comment">// 指向当前 CPU 上运行的进程的指针，如果没有正在运行的进程则为 null</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>            
</code></pre></li>
</ul>
</li>
<li>
<h5>系统调用</h5>
<p>用户程序通过系统调用请求系统服务，这是通过中断/陷入来实现的。</p>
<ul>
<li>在 xv6 中， <code>user.h</code> 定义了用户空间所需的系统调用接口、常量和数据结构</li>
<li>用户空间的系统调用接口函数会触发 <code>usys.S</code> 中定义的汇编语言接口函数，这些接口函数负责将系统调用号( 在 <code>syscall.h</code> 中定义 )加载到 <code>%eax</code> 寄存器中，然后执行 <code>int n</code> 指令，其中 n 是对应系统调用的中断向量号( <code>T_SYSCALL</code> 是一个定义在 <code>traps.h</code> 中的宏 )。<br>
这个中断会导致处理器进入内核模式执行系统调用处理程序。在开始中断处理程序之前，处理器会保存当前的寄存器状态，以便在从中断中返回时可以恢复它们。<br>
<img src="usys.png" alt="1"></li>
<li><code>tvinit()</code> 函数在 main 函数中被调用，它设置了 idt 表中的 256 个表项。在 xv6 中，中断 <code>T_SYSCALL</code> 是由 <code>tvinit</code> 处理的，用户系统调用会调用 <code>trap()</code> 函数。</li>
<li><code>trap()</code> 根据中断号 <code>tf-&gt;trapno</code> 来确定自身被调用的原因以及应该执行什么操作。如果中断是 <code>T_SYSCALL</code>，则 <code>trap()</code> 会调用系统调用处理程序 <code>syscall()</code><br>
<img src="trap.png" height="230px"></li>
<li><code>syscall()</code> 从中断帧中读取系统调用号，并根据该号调用相应的系统调用函数( <code>sys_</code> 开头，在 <code>sysproc.c</code> 中定义 )。系统调用函数按照惯例会在执行成功时返回一个正数，失败时返回一个小于 0 的数。如果系统调用号是非法的，<code>syscall()</code> 会打印错误信息并返回 -1。<br>
<img src="syscall.jpg" height="230px"></li>
<li>如何获得系统调用的参数？<br>
工具函数 <code>argint</code>、<code>argptr</code> 和 <code>argstr</code> 获得第 n 个系统调用参数，他们分别用于获取整数，指针和字符串起始地址。<code>argint</code> 利用用户空间的 <code>%esp</code> 寄存器定位第 n 个参数：<code>%esp</code> 指向系统调用结束后的返回地址。参数就恰好位于 <code>%esp+4</code>，因此第 n 个参数就在 <code>%esp+4+4*n</code></li>
<li>系统调用的实现（例如，<code>sysproc.c</code> 和 <code>sysfile.c</code> ）仅仅是封装而已,他们用 argint，argptr 和 argstr 来解析参数，然后调用真正的实现(通常在 <code>proc.c</code> 中)。</li>
</ul>
</li>
<li>
<h5>Makefile</h5>
<p>自动化构建和管理软件项目</p>
<ul>
<li>OBJS : 构建内核所需的所有源文件</li>
<li>UPROGS : 定义了一系列用户程序（应该可以理解为在终端输入的词通过Makefile链接到所编写的同名文件并执行用户程序）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="实验思路">实验思路 </h3>
<p>按照系统调用的过程来逐个文件添加或修改代码。</p>
<ul>
<li>
<h4><code>pstat.h</code></h4>
<p>在内核中填充 <code>pstat</code> 结构，存储每个进程的彩票信息的数据结构，并将结果传递到用户空间。</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">pstat</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> inuse<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 是否可运行（1或0）</span>
    <span class="token keyword keyword-int">int</span> ticket<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 此进程拥有的彩票数</span>
    <span class="token keyword keyword-int">int</span> pid<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 每个进程的进程ID</span>
    <span class="token keyword keyword-int">int</span> tick<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">// 每个进程已经运行的CPU时间片数量（被选择运行的次数）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//NPROC:最大进程数</span>
</code></pre></li>
<li>
<h4><code>user.h</code></h4>
<p>声明新增的两个系统调用：</p>
<ul>
<li><code>int settickets(int number)</code> ：设置调用进程的彩票数量。默认情况下，每个进程被分配5个彩票。调用 <code>settickets()</code> 使得进程可以增加彩票数量，从而获得更高比例的CPU周期。如果成功，返回0；否则返回-1（例如，如果调用者传入一个小于1的数字）。</li>
<li><code>int getpinfo(struct pstat *)</code> ：返回有关所有运行进程的信息，包括 struct pstat 的4个成员变量信息。可以用此系统调用构建 struct pstat *ps 。返回0表示成功，返回-1表示失败(例如，如果向内核传递了一个坏指针或NULL指针)。</li>
</ul>
<p>声明新增的结构体：<code>struct pstat</code></p>
</li>
<li>
<h4><code>testTcket.c</code></h4>
<p>用户程序。设置当前进程的票数。它接受一个整数参数作为命令行参数，并将其转换为票数。然后它使用 <code>settickets()</code> 系统调用来设置当前进程的票数为给定的值。主要作用是在用户空间调整进程的调度优先级。</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"user.h"</span></span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> argc<span class="token punctuation">,</span><span class="token keyword keyword-char">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//将字符串转换为int</span>
    <span class="token keyword keyword-int">int</span> number <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">settickets</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 保持进程的运行状态</span>
    <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li>
<h4><code>testProcInfo.c</code></h4>
<p>用户程序。显示当前正在运行的进程的信息（ <code>struct pstat</code> ），包括进程ID、是否可运行、分配的彩票数和已累积的CPU时间片数（ticks）。它通过调用 <code>getpinfo()</code> 系统调用来获取进程信息，然后将其打印到标准输出。主要作用是提供了一个简单的方式来查看系统中各个进程的调度情况和资源利用情况。</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"types.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"user.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pstat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"param.h"</span></span>

<span class="token keyword keyword-int">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> argc<span class="token punctuation">,</span><span class="token keyword keyword-char">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时间片总数</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">pstat</span> ps<span class="token punctuation">;</span>
    <span class="token function">getpinfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"\n------------ Initially assigned Tickets = %d ------------\n"</span><span class="token punctuation">,</span>InitialTickets<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"\nProcessID\tRunnable(0/1)\tTickets\t\tTicks\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NPROC <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>ps<span class="token punctuation">.</span>pid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> ps<span class="token punctuation">.</span>ticket<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"%d\t\t%d\t\t%d\t\t%d\n"</span><span class="token punctuation">,</span>ps<span class="token punctuation">.</span>pid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>ps<span class="token punctuation">.</span>inuse<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>ps<span class="token punctuation">.</span>ticket<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>ps<span class="token punctuation">.</span>tick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            count <span class="token operator">+=</span> ps<span class="token punctuation">.</span>tick<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"\n------------ Total Ticks = %d ------------\n\n"</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li>
<h4><code>usys.S</code></h4>
<p>这是一个汇编语言文件，用于定义用户空间系统调用的接口函数。这些接口函数是用户程序与操作系统内核之间的桥梁，通过它们，用户程序可以请求操作系统提供特定的服务或功能。usys.S 中定义的每个接口函数都会对应一个系统调用号，并且使用汇编代码来触发系统调用。<br>
我们需要添加两个宏定义：</p>
<pre data-role="codeBlock" data-info="S" class="language-s S"><code>SYSCALL(settickets)
SYSCALL(getpinfo)
</code></pre></li>
<li>
<h4><code>syscall.h</code></h4>
<p>该文件定义了系统调用号，我们需要在最后加上新增的两个系统调用号</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_settickets</span> <span class="token expression"><span class="token number">22</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SYS_getpinfo</span> <span class="token expression"><span class="token number">23</span></span></span>
</code></pre></li>
<li>
<h4><code>syscall.c</code></h4>
<p>负责处理用户程序发起的系统调用请求，执行相应的操作，并返回结果给用户程序。<br>
在此文件中需要新增系统调用函数声明及在函数指针数组中加入新增的系统调用。</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-extern">extern</span> <span class="token keyword keyword-int">int</span> <span class="token function">sys_settickets</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-extern">extern</span> <span class="token keyword keyword-int">int</span> <span class="token function">sys_getpinfo</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="" class="language-text"><code>[SYS_settickets]  sys_settickets,
[SYS_getpinfo]  sys_getpinfo,
</code></pre></li>
<li>
<h4><code>param.h</code></h4>
<p>定义了一些在整个操作系统中都会被使用的参数和常量<br>
需要新增对初始彩票值的定义：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">InitialTickets</span> <span class="token expression"><span class="token number">5</span></span></span>
</code></pre></li>
<li>
<h4><code>sysproc.c</code></h4>
<p>这个文件包含了 xv6 操作系统中所有系统调用的对应处理函数，但这相当于封装，然后以此调用真正的实现。<br>
需要在其中添加两个函数的处理函数：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> <span class="token function">sys_settickets</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword keyword-int">int</span> number<span class="token punctuation">;</span>
<span class="token comment">// 系统调用包装函数，用于从用户程序传递的参数中获取整数值，并将其存储在指定的变量中</span>
<span class="token function">argint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>number <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>number <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">settickets</span><span class="token punctuation">(</span>InitialTickets<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-else">else</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">settickets</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> <span class="token function">sys_getpinfo</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">pstat</span> <span class="token operator">*</span>ps<span class="token punctuation">;</span>
<span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token function">argptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword keyword-char">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ps<span class="token punctuation">,</span><span class="token keyword keyword-sizeof">sizeof</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">pstat</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token function">getpinfo</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li>
<h4><code>rand.h &amp; rand.c</code></h4>
<p>这两个文件的代码已给出，所需要用到的函数是 <code>random_at_most(total)</code> , 它的作用是生成一个小于等于 total 的随机数。</p>
</li>
<li>
<h4><code>defs.h</code></h4>
<p>该文件声明了一些系统调用的处理函数、内核函数、驱动函数等。<br>
添加 <code>struct pstat</code> 的声明，以及 <code>proc.c</code> 中新增的两个系统调用的实际执行函数：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> <span class="token function">settickets</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-int">int</span> <span class="token function">getpinfo</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">pstat</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></li>
<li>
<h4><code>proc.h</code></h4>
<p>这个文件中声明了与进程管理相关的结构体、宏定义和函数声明，我们需要修改 进程的结构，为其加上记录进程彩票数和运行的时间片数两个字段。</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> ticket<span class="token punctuation">;</span>                  <span class="token comment">//进程彩票数</span>
<span class="token keyword keyword-int">int</span> tick<span class="token punctuation">;</span>                    <span class="token comment">//时间片数    </span>
</code></pre></li>
<li>
<h4><code>proc.c</code></h4>
<p>这个文件包含了与进程管理相关的代码实现，其中可能包括了进程创建、销毁、调度等功能的具体实现。<br>
我们需要在这个文件中实现系统调用函数 <code>settickets()</code> 、<code>getpinfo()</code> 并修改进程初始化函数 <code>allocproc()</code> 、<code>fork()</code> 以及修改调度算法 <code>scheduler()</code></p>
<ul>
<li>
<h5>系统调用函数</h5>
<h5><code>settickets()</code></h5>
该函数要做的就是获取当前的进程，若当前进程存在，就把它进程结构体中的 ticket 字段设置为传入的值，要记得在处理进程时加锁。<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> <span class="token function">settickets</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> number<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>pr <span class="token operator">=</span> <span class="token function">myproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>pr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pr<span class="token operator">-&gt;</span>ticket <span class="token operator">=</span> number<span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre><h5><code>getpinfo()</code></h5>
在 xv6 中有一个进程表 ptable，用于跟踪系统中所有进程的信息，我们需要做的就是遍历进程表，把所有需要的数据转存到 ps 中，同样要记得在对进程进行操作时上锁。<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> <span class="token function">getpinfo</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">pstat</span> <span class="token operator">*</span>ps<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-struct">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
<span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword keyword-for">for</span><span class="token punctuation">(</span>p<span class="token operator">=</span>ptable<span class="token punctuation">.</span>proc<span class="token punctuation">;</span>p<span class="token operator">&lt;</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>proc<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ps<span class="token operator">-&gt;</span>pid<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>pid<span class="token punctuation">;</span>
    ps<span class="token operator">-&gt;</span>inuse<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>state <span class="token operator">!=</span> UNUSED<span class="token punctuation">;</span>
    ps<span class="token operator">-&gt;</span>ticket<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>ticket<span class="token punctuation">;</span>
    ps<span class="token operator">-&gt;</span>tick<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token operator">-&gt;</span>tick<span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-return">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></li>
<li>
<h5>进程初始化</h5>
<h5><code>allocproc()</code></h5>
这个函数会在创建进程时调用，我们需要把进程结构中的彩票数量初始化为 5 ，并把运行的时间片数量初始化为 0 。<pre data-role="codeBlock" data-info="c" class="language-c c"><code>p<span class="token operator">-&gt;</span>ticket <span class="token operator">=</span> InitialTickets<span class="token punctuation">;</span>
p<span class="token operator">-&gt;</span>tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre><h5><code>fork()</code></h5>
要求在创建子进程时继承父进程的彩票数量。所以只需将父进程的彩票数量赋给子进程，并将其 运行的时间片数量设置为 0。<pre data-role="codeBlock" data-info="c" class="language-c c"><code>np<span class="token operator">-&gt;</span>ticket <span class="token operator">=</span> curproc<span class="token operator">-&gt;</span>ticket<span class="token punctuation">;</span>
np<span class="token operator">-&gt;</span>tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre></li>
<li>
<h5>调度算法</h5>
这里要实现彩票调度，需要获取总彩票数来通过随机数函数生成中奖彩票，然后通过遍历进程表来找到拥有中奖彩票的进程，进程的切换通过更改 CPU 结构体的进程指针以及页表切换实现。<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span>
<span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">proc</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">cpu</span> <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">mycpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token operator">-&gt;</span>proc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//把当前的cpu空出来</span>
    
    <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 启用中断</span>
        <span class="token function">sti</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当前累计彩票数</span>
        <span class="token keyword keyword-long">long</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-long">long</span> cur_total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>p<span class="token operator">=</span>ptable<span class="token punctuation">.</span>proc<span class="token punctuation">;</span>p<span class="token operator">&lt;</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>proc<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state <span class="token operator">==</span> RUNNABLE<span class="token punctuation">)</span>
                total <span class="token operator">+=</span> p<span class="token operator">-&gt;</span>ticket<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword keyword-long">long</span> win_ticket <span class="token operator">=</span> <span class="token function">random_at_most</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 遍历进程表</span>
        <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> ptable<span class="token punctuation">.</span>proc<span class="token punctuation">;</span> p <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>proc<span class="token punctuation">[</span>NPROC<span class="token punctuation">]</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>state <span class="token operator">==</span> RUNNABLE<span class="token punctuation">)</span>
            cur_total <span class="token operator">+=</span> p<span class="token operator">-&gt;</span>ticket<span class="token punctuation">;</span>
        <span class="token keyword keyword-else">else</span>
            <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>cur_total <span class="token operator">&gt;</span> win_ticket<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            c<span class="token operator">-&gt;</span>proc <span class="token operator">=</span> p<span class="token punctuation">;</span><span class="token comment">// 设置当前CPU上正在运行的进程指针为选中的进程</span>
            <span class="token function">switchuvm</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 切换到特定进程的用户虚拟内存，页表切换</span>
            p<span class="token operator">-&gt;</span>state <span class="token operator">=</span> RUNNING<span class="token punctuation">;</span>
            <span class="token keyword keyword-int">int</span> tick_start <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
            <span class="token function">swtch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>scheduler<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">-&gt;</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//进行上下文切换，切换到选中进程执行</span>
            <span class="token keyword keyword-int">int</span> tick_end <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
            p<span class="token operator">-&gt;</span>tick <span class="token operator">+=</span> <span class="token punctuation">(</span>tick_end <span class="token operator">-</span> tick_start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
            <span class="token function">switchkvm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 切换回内核虚拟内存</span>
            <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span>
            <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptable<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><code>swtch(&amp;(c-&gt;scheduler), p-&gt;context);</code> 进行了一次上下文切换，将当前 CPU 的执行流从调度器（c-&gt;scheduler）切换到选中进程的上下文（p-&gt;context）。<br>
<code>switchuvm()</code> 将当前 CPU 的页表切换到指定进程的用户虚拟内存空间<br>
<code>ticks</code> 是一个全局变量，它用来记录自系统启动以来发生的时钟中断次数。</li>
</ul>
</li>
</ul>
<h3 id="运行结果">运行结果 </h3>
<p><img src="result.jpg" alt="1"><br>
可以看出测试结果符合彩票调度的思想：拥有的彩票数量越多被调度的几率越大</p>
<h2 id="总结">总结 </h2>
<p>在 xv6 中实现彩票调度算法的实验让我对操作系统调度机制有了更深入的理解。这个实验中，我们将传统的轮转调度算法替换为彩票调度算法，使进程被选中执行的概率与其拥有的彩票数成比例。通过这个实验，我学到了以下几点：</p>
<ul>
<li>
<h5>彩票调度算法原理</h5>
在传统的轮转调度算法中，每个进程都按照一定的顺序依次执行一段时间片。而在彩票调度算法中，每个进程被分配一定数量的彩票，然后在每次调度时，从所有彩票中随机选取一个彩票号，对应的进程被选中执行。</li>
<li>
<h5>xv6 的系统调用原理</h5>
第一次实验我们都是在用户空间操作，而这次进行了全栈操作，让我对 xv6 的操作系统架构有了进一步的了解。</li>
<li>
<h5>修改调度器</h5>
在实验中，我们将原来的轮转调度算法替换为彩票调度算法。</li>
<li>
<h5>添加系统调用</h5>
我学会了添加系统调用，一个用于设置进程的彩票数量，另一个用于获取系统中各进程的彩票分配情况。</li>
</ul>
<p>通过这个实验，我更深入地理解了操作系统调度算法的原理和实现方式，以及如何在现有的操作系统框架中实现新的调度算法。</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>