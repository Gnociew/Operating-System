<!DOCTYPE html><html><head>
      <title>project4</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\86182\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.13\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="华东师范大学数据学院实验报告">华东师范大学数据学院实验报告 </h1>
<table>
  <tbody><tr>
    <td>课程名称 ：操作系统</td>
    <td>年级：2022级</td>
    <td>上机实践成绩：</td>
  </tr>
  <tr>
    <td>指导教师：翁楚良</td>
    <td>姓名：刘蔚璁</td>
    <td></td>
  </tr>
  <tr>
    <td>上机实践名称：Locks </td>
    <td>学号：10225501443</td>
    <td>上机实践日期：2024.6</td>
  </tr>
</tbody></table>
<h2 id="一-实验目的">一、实验目的 </h2>
<ul>
<li>优化block cache争用</li>
<li>改进 xv6 操作系统的缓冲区缓存（buffer cache），以减少在多进程频繁使用文件系统时对 <code>bcache.lock</code> 的争用。</li>
</ul>
<h2 id="二-实验内容">二、实验内容 </h2>
<ul>
<li>原始版本的 buffer cache 由一个大锁 <code>bcache.lock</code> 保护, 限制了并行运行的效率，且使用的是双链表的管理方式。</li>
<li>修改 <code>kernel/bio.c</code> 文件：放弃双链表的管理方式，利用 hash bucket 思想修改缓冲区缓存，以减少对 <code>bcache.lock</code> 的争用。使用哈希表在缓存中查找块号 block number，哈希表的每个哈希桶都有一个锁。</li>
<li>删除所有缓冲区的列表（如 <code>bcache.head</code> 等），改为使用缓冲区上次使用的时间戳（即使用 <code>kernel/trap.c</code> 中的 <code>ticks</code> ）。通过这种改变， <code>brelse</code> 不需要获取 <code>bcache</code> 锁， <code>bget</code> 可以基于 ticks 选择最近最少使用的块。</li>
<li>运行 <code>bachetest</code> 时，<code>bcache</code> 中所有锁的 <code>acquire</code> 循环迭代次数接近于零。理想情况下，块缓存中涉及的所有锁的计数之和应该为0，本实验允许总和小于500。</li>
<li>保持每个块最多只有一个缓存副本的不变性。</li>
</ul>
<h2 id="三-实验环境">三、实验环境 </h2>
<ul>
<li>Ubuntu</li>
<li>VSCode</li>
</ul>
<h2 id="四-实验过程及结果">四、实验过程及结果 </h2>
<h3 id="预备知识">预备知识 </h3>
<h4 id="自旋锁和睡眠锁">自旋锁和睡眠锁 </h4>
<ul>
<li>
<h5>自旋锁</h5>
自旋锁是一种简单的锁机制，它使用忙等待的方式来获取锁。当一个线程尝试获取自旋锁时，如果锁已经被其他线程持有，那么该线程会一直循环检查锁的状态，直到获取到锁为止。<br>
在xv6中，自旋锁通常用于保护短期的临界区，因为自旋锁不会引起线程的睡眠，不会导致线程上下文的切换，因此适用于临界区执行时间较短的情况。
<ul>
<li>
<p>使用场景：</p>
<ul>
<li>保护共享资源的临界区，例如对内核数据结构的访问。</li>
<li>在内核中的中断处理程序中，因为中断处理程序通常需要尽快完成，自旋锁可以避免睡眠造成的延迟。</li>
</ul>
</li>
<li>
<p><strong>常见操作：</strong></p>
<ul>
<li><code>initlock(struct spinlock *lk, char *name)</code>: 初始化自旋锁。</li>
<li><code>acquire(struct spinlock *lk)</code>: 获取自旋锁。</li>
<li><code>release(struct spinlock *lk)</code>: 释放自旋锁。</li>
</ul>
</li>
</ul>
</li>
<li>
<h5>睡眠锁</h5>
睡眠锁是一种更高级别的锁机制，它在锁已被其他线程持有时，会使当前线程进入睡眠状态，等待锁的释放。与自旋锁不同，睡眠锁可以在获取锁时释放CPU，允许其他线程运行。<br>
在xv6中，睡眠锁通常用于保护长期的临界区，因为长时间的自旋等待可能会浪费CPU资源。此外，睡眠锁也可以用于需要休眠的情况，例如等待磁盘I/O完成。
<ul>
<li>使用场景：
<ul>
<li>保护共享资源的长期临界区，例如文件系统中的数据结构访问。</li>
<li>等待外部事件发生，例如等待磁盘I/O完成。</li>
</ul>
</li>
<li><strong>常见操作：</strong>
<ul>
<li><code>initsleeplock(struct sleeplock *lk, char *name)</code>: 初始化睡眠锁。</li>
<li><code>acquiresleep(struct sleeplock *lk)</code>: 获取睡眠锁。</li>
<li><code>releasesleep(struct sleeplock *lk)</code>: 释放睡眠锁。</li>
<li><code>holdingsleep(struct sleeplock *lk)</code>: 检查当前线程是否持有睡眠锁。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="缓存管理">缓存管理 </h4>
<p>在 xv6 操作系统中，buf 和 bcache 是用于磁盘 I/O 缓冲管理的关键数据结构。它们用于缓存从磁盘读取或写入的块（block），从而提高了文件系统的性能。</p>
<ul>
<li>
<h5>buf 结构体</h5>
buf 结构体代表了一个磁盘块（block）的缓冲区，它包含了磁盘块的数据以及与之相关的元数据，用于实现缓存机制，以提高对频繁访问的块的访问速度。<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-int">int</span> valid<span class="token punctuation">;</span>   <span class="token comment">/* 表示缓冲区中的数据是否有效。
    如果 valid 为 1，表示缓冲区中的数据已经从磁盘读取并有效，
    如果为 0，则表示数据无效，可能是未初始化或者数据已过期。*/</span>
    <span class="token keyword keyword-int">int</span> disk<span class="token punctuation">;</span>    <span class="token comment">// 表示该缓冲区是否由磁盘 "拥有"。</span>
    uint dev<span class="token punctuation">;</span>    <span class="token comment">// 表示磁盘设备的编号 </span>
    uint blockno<span class="token punctuation">;</span><span class="token comment">// 表示磁盘上的块号</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">sleeplock</span> lock<span class="token punctuation">;</span> <span class="token comment">// 一个睡眠锁，用于保护对该缓冲区的访问。</span>
    uint refcnt<span class="token punctuation">;</span> <span class="token comment">// 缓冲区的引用计数，表示有多少线程正在使用该缓冲区。</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment">// LRU cache list</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    uchar data<span class="token punctuation">[</span>BSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 用于存储磁盘块的实际数据</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></li>
<li>
<h5>bcache 结构体</h5>
bcache 结构体代表了整个磁盘缓冲区（buffer cache），它是管理所有 buf 结构体的容器。它的主要作用是管理缓冲区的分配与回收，以及提供对缓冲区的高效访问。它提供了一种机制，使得磁盘 I/O 操作可以尽可能地利用缓冲区，从而提高了文件系统的性能。<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token comment">// 包含缓冲区缓存的结构体</span>
<span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自旋锁，用于保护缓冲区缓存的数据结构</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
    <span class="token comment">// 缓冲区数组，每个元素都是一个缓冲区</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> buf<span class="token punctuation">[</span>NBUF<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 所有缓冲区的链表，通过prev/next指针连接</span>
    <span class="token comment">// 链表按最近使用的顺序排序</span>
    <span class="token comment">// head.next是最近使用的缓冲区，head.prev是最久未使用的缓冲区</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span> bcache<span class="token punctuation">;</span>
</code></pre></li>
<li>在原始写法中，整个 bcache 由一个自旋锁保护，在任何时刻只有一个线程可以修改 bcache。</li>
<li>bcache 中的缓冲区是通过双向链表组织的，通常用于实现缓存的替换策略。xv6 使用头插法插入最近使用的缓冲区，以确保最近使用的缓冲区总是位于链表的头部。</li>
</ul>
<h3 id="实验思路">实验思路 </h3>
<p>实验的核心分为两点：</p>
<ul>
<li>把原本一整个磁盘缓冲区分为若干个桶，使用块号把不同的缓冲块哈希到不同的桶中，并把原本的对整个缓冲区加锁改成对每个桶分别加锁。
<ul>
<li>修改前<br>
<img src="改前.jpg" height="100px"></li>
<li>修改后<br>
<img src="改后.jpg" height="209px"></li>
</ul>
</li>
<li>原本根据双向链表逆向检索实现 LRU（最近最少使用） 组织缓冲块，现在改成数组 + 系统时间中断数来找到目标块。</li>
</ul>
<h4 id="数据结构修改">数据结构修改 </h4>
<p>据此，先对两个数据结构进行修改：</p>
<ul>
<li>
<h5><code>struct buf</code></h5>
添加字段：<code>uint timestamp;</code> ，该字段用于记录最后使用缓存块的时间。</li>
<li>
<h5><code>struct bcache</code> -&gt; <code>struct bcachebucket</code></h5>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUCKETSIZE</span> <span class="token expression"><span class="token number">13</span> </span><span class="token comment">// number of hashing buckets</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFFERSIZE</span> <span class="token expression"><span class="token number">5</span> </span><span class="token comment">// number of available buckets per bucket</span></span>

<span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">spinlock</span> lock<span class="token punctuation">;</span>
    <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> buf<span class="token punctuation">[</span>BUFFERSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> bcachebucket<span class="token punctuation">[</span>BUCKETSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>这个结构定义了一个 bcachebucket 数组，数组的每个元素代表一个桶，每个桶中包含一个自旋锁和一个 buf 数组，用于存放映射到该桶中的缓冲块。</li>
</ul>
<h4 id="相关函数修改">相关函数修改 </h4>
<h5 id="hash"><code>hash()</code> </h5>
<p>首先定义一个哈希函数，用于根据块号将不同块映射到相应桶中。</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-int">int</span> 
<span class="token function">hash</span><span class="token punctuation">(</span>uint blockno<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> blockno <span class="token operator">%</span> BUCKETSIZE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="binit"><code>binit()</code> </h5>
<p>首先观察原始的 <code>bint</code> 实现的功能：</p>
<ul>
<li>为整个磁盘缓冲区分配一个自旋锁</li>
<li>创建缓存块的双向链表</li>
<li>对每个缓存块初始化一个睡眠锁</li>
</ul>
<p>而我们现在需要做的是：</p>
<ul>
<li>为每个桶分配一个自旋锁</li>
<li>对每个缓存块初始化一个睡眠锁</li>
</ul>
<p>因此得到代码：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span> <span class="token function">binit</span><span class="token punctuation">(</span><span class="token keyword keyword-void">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUCKETSIZE <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">initlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span><span class="token string">"bcachebucket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> j <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> j <span class="token operator">&lt;</span> BUFFERSIZE <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">initsleeplock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">,</span><span class="token string">"buffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="bget"><code>bget()</code> </h5>
<p>该函数用于查找设备上的缓存块，如果没有找到则分配一个新的缓存块，无论哪种情况最后都返回被锁定的缓存块。<br>
原始方法的实现逻辑是：</p>
<ul>
<li>通过 dev 和 blockno 检测块是否已经在缓存中，若在缓存中，获取该块的锁并返回该块</li>
<li>如果块不在缓存中，通过反向检索链表找到最近最少使用的空闲块，重新初始化其字段，获取该块的锁并返回该块</li>
<li>若找不到可用的缓冲块，触发恐慌</li>
</ul>
<p>我们需要修改的是：</p>
<ul>
<li>首先得到该块映射到的桶号，若该桶中没有就代表缓冲区中没有该块</li>
<li>不通过双向链表实现LRU，而是通过比较 timestamp 来找到桶中的 LRU 空闲块，timestamp 越小表示上次被使用的时间越早，要选择上次使用时间最早的空闲块</li>
<li>进一步优化，若该桶中不存在空闲块，到邻居桶中查找</li>
<li>因为要保持每个块最多只有一个缓存副本的不变性，所以优化时应该也查找邻居桶看是否存在该块，不存在才能开始寻找空闲块，否则可能出现一个块有两个缓存副本的情况</li>
</ul>
<p>具体代码如下：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span><span class="token operator">*</span>
<span class="token function">bget</span><span class="token punctuation">(</span>uint dev<span class="token punctuation">,</span>uint blockno<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>

  <span class="token keyword keyword-int">int</span> bucket <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-int">int</span> finalBuc <span class="token operator">=</span> bucket<span class="token punctuation">;</span>

  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-for">for</span><span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUFFERSIZE <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span><span class="token punctuation">{</span>
      b <span class="token operator">=</span> <span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
      b<span class="token operator">-&gt;</span>timestamp <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-return">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><pre data-role="codeBlock" data-info="c" class="language-c c"><code>  <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bucket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUFFERSIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        b <span class="token operator">=</span> <span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
        b<span class="token operator">-&gt;</span>timestamp <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> b<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bucket <span class="token operator">&lt;</span> BUCKETSIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUFFERSIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dev <span class="token operator">==</span> dev <span class="token operator">&amp;&amp;</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>blockno <span class="token operator">==</span> blockno<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        b <span class="token operator">=</span> <span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
        b<span class="token operator">-&gt;</span>timestamp <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> b<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span>

  uint flag <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-int">int</span> idex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUFFERSIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>refcnt <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> flag<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      flag <span class="token operator">=</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
      idex <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 在邻居 bucket 中获取空闲块</span>
  <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>idex <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bucket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUFFERSIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>refcnt <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> flag<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          flag <span class="token operator">=</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
          idex <span class="token operator">=</span> i<span class="token punctuation">;</span>
          finalBuc <span class="token operator">=</span> bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bucket <span class="token operator">&lt;</span> BUCKETSIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-int">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> BUFFERSIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>refcnt <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp <span class="token operator">&lt;</span> flag<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          flag <span class="token operator">=</span> bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
          idex <span class="token operator">=</span> i<span class="token punctuation">;</span>
          finalBuc <span class="token operator">=</span> bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>idex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>finalBuc<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>finalBuc<span class="token punctuation">]</span><span class="token punctuation">.</span>buf<span class="token punctuation">[</span>idex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> dev<span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>blockno <span class="token operator">=</span> blockno<span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    b<span class="token operator">-&gt;</span>refcnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>finalBuc<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">acquiresleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bget: no buffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span>
</code></pre><h5 id="brelse"><code>brelse()</code> </h5>
<p>该函数的作用是释放锁定的缓冲块。<br>
首先观察原函数：</p>
<ul>
<li>先检查当前线程是否持有需要释放的缓冲块的睡眠锁，若无则引发恐慌</li>
<li>接着获取整个缓冲区的自旋锁</li>
<li>减少对缓冲块的引用计数（refcnt，代表当前有几个进程正在使用该块）</li>
<li>如果引用计数为0，表示没有线程在使用这个缓冲块</li>
<li>把缓冲块从链表当前位置移除并使用头插法重新插入链表中</li>
</ul>
<p>我们需要改动的是：</p>
<ul>
<li>若引用计数为零，使用 ticks 重置 timestamp</li>
</ul>
<p>具体代码如下：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span>
<span class="token function">brelse</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">holdingsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"brelse"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token function">releasesleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword keyword-int">int</span> bucket <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-&gt;</span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>refcnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    b<span class="token operator">-&gt;</span>timestamp <span class="token operator">=</span> ticks<span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="bpin--bunpin"><code>bpin()</code> / <code>bunpin()</code> </h5>
<p>这两个函数的作用是增加或减少缓冲块的引用计数。<br>
原始函数和所修改函数的唯一区别是：</p>
<ul>
<li>原始函数在操作前对整个磁盘缓冲区上锁</li>
<li>修改后的函数只需要对相应的桶上锁</li>
</ul>
<p>具体代码如下：</p>
<pre data-role="codeBlock" data-info="c" class="language-c c"><code><span class="token keyword keyword-void">void</span>
<span class="token function">bpin</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword keyword-int">int</span> bucket <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-&gt;</span>refcnt<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-void">void</span>
<span class="token function">bunpin</span><span class="token punctuation">(</span><span class="token keyword keyword-struct">struct</span> <span class="token class-name">buf</span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword keyword-int">int</span> bucket <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>b<span class="token operator">-&gt;</span>blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
  b<span class="token operator">-&gt;</span>refcnt<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token function">release</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bcachebucket<span class="token punctuation">[</span>bucket<span class="token punctuation">]</span><span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="测试结果">测试结果 </h4>
<ul>
<li>
<h5>bcachetest</h5>
  <img src="r1.jpg" height="66px">
</li>
<li>
<h5>usertests</h5>
  <img src="r21.jpg" height="76px">
<p>......(省略中间测试)<br>
<img src="r22.jpg" height="76px"></p>
</li>
</ul>
<h2 id="五-总结与反思">五、总结与反思 </h2>
<p>本次实验深入探讨了 xv6 操作系统中的缓冲区管理机制，包括相关的数据结构 buf 和 bcache 以及对缓冲区的操作函数的实现细节。通过分析和改写代码，我理解了以下关键点：</p>
<h4 id="缓冲区管理机制">缓冲区管理机制： </h4>
<ul>
<li>buf 结构体用于表示文件系统的缓冲块，包括数据、引用计数、锁、设备号和块号等信息。</li>
<li>bcache 是一个缓冲区缓存结构，使用一个双向链表来管理所有的缓冲块，支持最近最少使用（LRU）的缓存替换策略。</li>
</ul>
<h4 id="锁机制">锁机制： </h4>
<ul>
<li>bcache 使用自旋锁来保护共享数据结构，确保多线程环境下的线程安全。</li>
<li>buf 结构体中的缓冲块使用睡眠锁来防止并发访问。</li>
</ul>
<h4 id="缓冲区相关函数的作用和实现细节">缓冲区相关函数的作用和实现细节： </h4>
<ul>
<li>binit() : 初始化缓冲区及缓冲块</li>
<li>bget() : 用于查找设备上的缓存块，如果没有找到则分配一个新的缓存块</li>
<li>brelse() : 释放锁定的缓冲块</li>
<li>bpin() / bunpin() : 增加或减少缓冲块的引用计数</li>
<li>实现细节均已在第四部分体现</li>
</ul>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>